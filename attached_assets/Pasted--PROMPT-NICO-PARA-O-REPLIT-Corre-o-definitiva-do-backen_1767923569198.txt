âœ… PROMPT ÃšNICO PARA O REPLIT
(CorreÃ§Ã£o definitiva do backend â€“ fluxo por etapa, intents e LLM)
ğŸ”§ Objetivo geral
Alinhar o backend estritamente ao recipe.yml e ao Interaction Model da Alexa, garantindo que:
Nenhuma etapa com input obrigatÃ³rio seja pulada
Nenhum input estruturado seja interpretado por LLM ou texto livre
NÃ£o exista concorrÃªncia entre intents
O fluxo seja determinÃ­stico, previsÃ­vel e estÃ¡vel
1ï¸âƒ£ Controle de fluxo por etapa (REGRA MESTRA)
Implemente stage-aware intent gating no backend.
Regra obrigatÃ³ria
Se a etapa atual possui operator_input_required e ainda hÃ¡ inputs pendentes, entÃ£o:
âŒ Bloquear advance
âŒ Bloquear ProcessCommandIntent
âŒ Bloquear LLM
âœ… Aceitar somente a intent esperada da etapa
âœ… Permitir apenas AMAZON.HelpIntent e AMAZON.StopIntent
PseudocÃ³digo esperado
const stage = getCurrentStage(batch);

if (stage.operator_input_required?.length && !stage.inputsSatisfied) {
  if (
    intent.name !== stage.expected_intent &&
    intent.name !== "AMAZON.HelpIntent" &&
    intent.name !== "AMAZON.StopIntent"
  ) {
    return respondWith(stage.input_prompt);
  }
}
2ï¸âƒ£ Mapeamento explÃ­cito de intent esperada por etapa
Use exatamente este mapeamento no backend:
Etapa	expected_intent
6 â€“ Anotar horÃ¡rio de floculaÃ§Ã£o	LogTimeIntent
7 â€“ Anotar horÃ¡rio do ponto de corte	LogTimeIntent
13 â€“ Medir pH inicial e registrar peÃ§as	RegisterPHAndPiecesIntent
14 â€“ Colocar na prensa	LogTimeIntent
19 â€“ Transferir para CÃ¢mara 2	RegisterChamberEntryDateIntent
âš ï¸ Importante:
RegisterChamberEntryDateIntent nÃ£o possui â€œ2â€ no nome
O backend nÃ£o deve inferir intent por texto
3ï¸âƒ£ Registro de horÃ¡rios (LogTimeIntent)
Para LogTimeIntent:
âŒ Nunca interpretar horÃ¡rio por texto livre
âŒ Nunca chamar LLM
âŒ Nunca usar regex
âœ… Ler exclusivamente:
slots.time.value (AMAZON.TIME)
slots.time_type.value (TIME_TYPE)
PersistÃªncia correta
Mapear time_type para o campo correto da etapa:
time_type	campo salvo
floculaÃ§Ã£o	flocculation_time
corte	cut_point_time
moldagem / prensa	press_start_time
ApÃ³s salvar:
Marcar input como satisfeito
Se nÃ£o houver outros inputs pendentes, permitir avanÃ§o da etapa
4ï¸âƒ£ Etapa 13 â€“ pH e quantidade de peÃ§as
Para RegisterPHAndPiecesIntent:
âŒ NÃ£o aceitar texto livre
âŒ NÃ£o usar LLM
âœ… Ler apenas:
ph_value (AMAZON.NUMBER)
pieces_quantity (AMAZON.NUMBER)
PersistÃªncia
Salvar ph_value como initial_ph
Salvar pieces_quantity normalmente
Registrar ambos com stageId = 13
Somente apÃ³s os dois valores:
Marcar etapa como completa
Liberar avanÃ§o
5ï¸âƒ£ Etapa 19 â€“ Entrada na CÃ¢mara 2
Para RegisterChamberEntryDateIntent:
âŒ NÃ£o aceitar texto livre
âŒ NÃ£o interpretar â€œhojeâ€, â€œontemâ€ manualmente
âŒ NÃ£o usar LLM
âœ… Ler apenas:
entry_date (AMAZON.DATE)
PersistÃªncia
Salvar em chamber_2_entry_date
Registrar com stageId = 19
ApÃ³s salvar:
Marcar etapa como completa
Iniciar contagem de maturaÃ§Ã£o conforme recipe.yml
6ï¸âƒ£ ProcessCommandIntent (uso correto)
ProcessCommandIntent deve continuar existindo, porÃ©m:
Permitido SOMENTE quando:
A etapa nÃ£o possui operator_input_required pendente
Usos vÃ¡lidos:
InÃ­cio de lote
Consulta de fermentos (â€œqual o KLâ€)
Status
Ajuda
ExplicaÃ§Ãµes
Bloqueado quando:
Etapa estiver em modo de coleta obrigatÃ³ria (LOCKED)
7ï¸âƒ£ LLM (polÃ­tica obrigatÃ³ria)
O LLM:
âœ… Pode:
Explicar etapas (llm_guidance)
Esclarecer dÃºvidas
ReforÃ§ar cuidados
âŒ NÃ£o pode:
Interpretar nÃºmeros
Interpretar datas
Interpretar horÃ¡rios
Decidir avanÃ§o de etapa
Preencher inputs obrigatÃ³rios
O backend nÃ£o deve chamar o LLM em nenhuma etapa com input obrigatÃ³rio pendente.
8ï¸âƒ£ UX obrigatÃ³ria (respostas)
Nunca responder apenas:
Missing required inputs
Sempre responder com orientaÃ§Ã£o explÃ­cita, por exemplo:
Etapa 7:
â€œRegistre o horÃ¡rio do ponto de corte dizendo: â€˜hora do corte Ã s quinze e vinteâ€™.â€
Etapa 13:
â€œInforme o pH inicial e a quantidade de peÃ§as dizendo: â€˜pH cinco e quatro e seis peÃ§asâ€™.â€
9ï¸âƒ£ Limpeza de inconsistÃªncias anteriores
âŒ Remover gravaÃ§Ãµes genÃ©ricas como recorded_time
âŒ NÃ£o registrar mÃºltiplos horÃ¡rios para a mesma etapa
âœ… Cada input deve ser:
Ãšnico
Associado Ã  etapa correta
Sobrescrito apenas se explicitamente refeito